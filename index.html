<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Bureau Émulé — PulseTech</title>
<style>
/* ---------- Reset & base ---------- */
*{box-sizing:border-box;margin:0;padding:0}
html,body{height:100%;font-family:Inter, system-ui, "Segoe UI", Roboto, "Helvetica Neue", Arial;overflow:hidden;background:#0d1117;color:#e6e6e6}
:root{
  --taskbar-size:60px;
  --icon-size:80px;
  --taskbar-bg: rgba(40,40,40,0.85);
  --taskbar-transparency:0.85;
  --accent:#0078d7;
  --taskbar-position:bottom;
  --animations:1;
  --dock-zoom:2.2;
  --dock-radius:120;
}

/* ---------- Background: support image or video ---------- */
#bg-video, #bg-image {
  position:fixed; inset:0; z-index:-100; width:100%; height:100%; object-fit:cover;
}
#bg-video {display:none;}
#bg-overlay{position:fixed;inset:0;z-index:-50;background:rgba(0,0,0,0.1);pointer-events:none}
html:fullscreen #bg-video, html:fullscreen #bg-image {
  width:100vw; height:100vh; object-fit:cover;
}

/* ---------- Desktop ---------- */
#desktop{position:absolute;left:0;top:0;right:0;bottom:var(--taskbar-size);user-select:none;overflow:hidden}
#desktop.fullscreen{bottom:0}

/* ---------- Desktop icons ---------- */
.icon{
  width:var(--icon-size); text-align:center; position:absolute;
  display:flex; flex-direction:column; align-items:center; gap:6px; font-size:14px; cursor:pointer;
  transition: transform 0.12s ease, background 0.12s ease, border-radius 0.12s;
  padding:6px;
}
.icon img{width:calc(var(--icon-size)*0.6);height:calc(var(--icon-size)*0.6);object-fit:contain}
.icon span{font-size:calc(var(--icon-size)*0.14);color:#fff;text-shadow:0 1px 2px rgba(0,0,0,0.6);white-space:nowrap;overflow:hidden;text-overflow:ellipsis;max-width:calc(var(--icon-size)+10px)}

/* ---------- Taskbar (macOS Dock style) ---------- */
#taskbar{
  position:fixed; z-index:900; display:flex; align-items:center; justify-content:center;
  bottom:10px; left:50%; transform: translateX(-50%); height:var(--taskbar-size); width:auto;
  background: rgba(40,40,40,0.85); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  border-radius: 16px; padding: 8px 12px; box-shadow: 0 4px 20px rgba(0,0,0,0.4);
  transition: all 0.25s ease; gap: 12px;
}

/* Center icons (dock) */
#taskbar-center{
  display:flex; align-items:center; justify-content:center; gap:10px; flex:1; z-index:905; pointer-events:auto;
}

/* Right tray */
#taskbar-right{
  position:relative; display:flex; align-items:center; gap:8px; z-index:910;
}

/* Taskbar icons */
.taskbar-icon{
  width:48px; height:48px; border-radius:12px; display:flex; align-items:center; justify-content:center;
  cursor:pointer; transition:transform 0.12s ease, box-shadow 0.12s, background 0.12s;
  user-select:none; overflow:visible; position: relative; background: rgba(255,255,255,0.1);
}
.taskbar-icon img{width:32px; height:32px; pointer-events:none;}
.taskbar-icon.active{background: rgba(255,255,255,0.2); box-shadow:0 0 12px rgba(255,255,255,0.3);}
.taskbar-icon::after {
  content: ''; position: absolute; bottom: -4px; left: 50%; transform: translateX(-50%);
  width: 6px; height: 6px; border-radius: 50%; opacity: 0; transition: opacity 0.12s;
}
.taskbar-icon.open::after { background: #00ff00; opacity: 1; }
.taskbar-icon.minimized::after { background: #ffff00; opacity: 1; }

/* Bounce animation for launch */
@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-15px); }
  60% { transform: translateY(-7px); }
}
.taskbar-icon.bouncing { animation: bounce 0.6s ease; }

/* Dock scaling wrapper */
.dock-item{display:flex;align-items:center;justify-content:center;transition:transform 0.12s ease;transform-origin:center center}

/* Window frames */
.window-frame {
  position: absolute; width: 800px; height: 600px; display: none; flex-direction: column;
  border-radius: 12px; overflow: hidden; box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
  background: #ffffff; color: #000; z-index: 1000; transition: all 0.25s ease;
  backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px);
}
.window-frame.show { display: flex; }

/* Window header */
.window-header {
  background: rgba(242, 242, 242, 0.8); backdrop-filter: blur(12px); -webkit-backdrop-filter: blur(12px);
  color: #000; padding: 8px 12px; display: flex; align-items: center; justify-content: flex-start;
  cursor: grab; height: 36px; border-bottom: 1px solid rgba(0, 0, 0, 0.1);
}

/* Window controls (macOS traffic lights) */
.window-controls {
  display: flex; gap: 8px; margin-right: 12px; order: -1;
}
.window-controls span {
  width: 12px; height: 12px; border-radius: 50%; cursor: pointer; transition: all 0.2s ease;
  display: flex; align-items: center; justify-content: center;
}
.window-controls .close { background: #ff5f57; border: 1px solid #e0443e; }
.window-controls .min { background: #ffbd2e; border: 1px solid #e0a423; }
.window-controls .max { background: #28c940; border: 1px solid #20a733; }
.window-controls span:hover { filter: brightness(1.1); }

/* Window title */
.window-title {
  font-size: 13px; font-weight: 600; text-align: center; flex-grow: 1;
}

/* Window body */
.window-body {
  flex: 1; overflow: auto; background: #ffffff;
}

/* Start menu & context */
#start-menu{position:fixed;z-index:950;left:12px;bottom:calc(var(--taskbar-size) + 12px);width:320px;background:rgba(30,30,30,0.95);padding:12px;border-radius:10px;display:none;box-shadow:0 6px 20px rgba(0,0,0,0.5)}
.context-menu{position:fixed;z-index:960;background:rgba(40,40,40,0.95);padding:8px;border-radius:8px;display:none}
.context-item{padding:8px 12px;border-radius:6px;cursor:pointer}
.context-item:hover{background:rgba(255,255,255,0.04)}

/* Settings modal (tabs) */
.settings-modal{width:720px;max-width:92vw;height:520px;border-radius:12px;background:linear-gradient(180deg,#111,#0b0b0b);color:#fff;border:1px solid rgba(255,255,255,0.04);display:flex;flex-direction:column;overflow:hidden}
.settings-header{display:flex;align-items:center;justify-content:space-between;padding:12px;border-bottom:1px solid rgba(255,255,255,0.03)}
.settings-body{display:flex;flex:1;overflow:hidden}
.settings-tabs{width:220px;padding:12px;border-right:1px solid rgba(255,255,255,0.02);display:flex;flex-direction:column;gap:6px;background:linear-gradient(180deg,rgba(255,255,255,0.02),transparent)}
.tab{padding:10px;border-radius:8px;cursor:pointer}
.tab.active{background:linear-gradient(90deg,rgba(255,255,255,0.03), rgba(255,255,255,0.01));box-shadow:inset 0 0 0 1px rgba(255,255,255,0.02)}
.tab-icon{display:inline-block;width:28px}
.tab-content{flex:1;padding:16px;overflow:auto}
.control{margin-bottom:12px;display:flex;gap:10px;align-items:center}
.control label{min-width:160px;color:#ddd}
.select, input[type="range"], input[type="text"], select{padding:8px;border-radius:8px;background:#111;border:1px solid rgba(255,255,255,0.04);color:#fff}
.switch{display:inline-flex;align-items:center;gap:8px}
.btn{padding:8px 12px;border-radius:8px;background:var(--accent);border:none;color:#fff;cursor:pointer}

/* Small responsive tweaks */
@media (max-width:900px){
  .settings-modal{width:94vw;height:86vh}
  #desktop{bottom:calc(var(--taskbar-size) + 0px)}
}

/* ---------- Animations toggle ---------- */
html[data-animations="0"] *{transition:none !important}

/* Toast */
.toast{position:fixed;right:20px;bottom:calc(var(--taskbar-size) + 20px);padding:10px 14px;border-radius:8px;background:#2ecc71;color:#fff;z-index:2000}
.toast.error{background:#e74c3c}
</style>
</head>
<body>

<!-- Background image or video -->
<img id="bg-image" src="/site/win3/fond.jpg" alt="wallpaper" style="display:block"/>
<video id="bg-video" autoplay muted loop playsinline style="display:none"></video>
<div id="bg-overlay"></div>

<!-- Desktop -->
<div id="desktop"></div>

<!-- Start menu and context -->
<div id="start-menu"><h3>Applications</h3><div id="start-apps"></div></div>
<div id="context-menu" class="context-menu"></div>

<!-- Taskbar (Dock) -->
<div id="taskbar" class="bottom" role="toolbar">
  <div id="taskbar-center"></div>
  <div id="taskbar-right" style="display:flex;align-items:center;">
    <button id="fullscreen-btn" class="btn" title="Plein écran">⛶</button>
    <button id="settings-btn" class="btn" title="Paramètres">⚙</button>
  </div>
</div>

<script>
/* ==========================
   State & defaults
   ========================== */
const desktop = document.getElementById('desktop');
const taskbar = document.getElementById('taskbar');
const taskbarCenter = document.getElementById('taskbar-center');
const bgImage = document.getElementById('bg-image');
const bgVideo = document.getElementById('bg-video');
let lastBlobUrl = null;

const DEFAULTS = {
  iconSize: 'medium',
  iconSizes: { small:60, medium:80, large:100 },
  taskbarSize: 60,
  taskbarPosition: 'bottom',
  taskbarTransparency: 0.85,
  theme: 'dark',
  animations: true,
  dockEffect: true,
  dockZoom: 2.2,
  dockRadius: 120,
  showClock: false,
  clockFormat24: true,
  backgroundType: 'image',
  backgroundData: '/site/win3/fond.jpg',
  minimizeAnimation: true,
  closeAnimation: true,
  launchBounce: true,
};

let settings = Object.assign({}, DEFAULTS, JSON.parse(localStorage.getItem('emulatorSettings') || '{}'));

/* Validate and reset corrupted settings */
try {
  if (!settings.backgroundType || !['image', 'video', 'none'].includes(settings.backgroundType)) {
    settings.backgroundType = DEFAULTS.backgroundType;
    settings.backgroundData = DEFAULTS.backgroundData;
  }
} catch (e) {
  console.error('Corrupted settings detected, resetting to defaults:', e);
  settings = Object.assign({}, DEFAULTS);
}

/* Utility: Validate URL with better handling */
function isValidUrl(url) {
  try {
    const parsed = new URL(url.startsWith('/') ? window.location.origin + url : url);
    return parsed.protocol === 'http:' || parsed.protocol === 'https:' || parsed.protocol === 'file:';
  } catch {
    return false;
  }
}

/* Utility: Check network connectivity */
function checkConnectivity() {
  return navigator.onLine;
}

/* Utility: Debounce function */
function debounce(func, wait) {
  let timeout;
  return function executedFunction(...args) {
    const later = () => {
      clearTimeout(timeout);
      func(...args);
    };
    clearTimeout(timeout);
    timeout = setTimeout(later, wait);
  };
}

/* Utility: Load resource with retry */
function loadResource(url, type, maxRetries = 2, retryDelay = 1000) {
  return new Promise((resolve, reject) => {
    let attempts = 0;
    const load = () => {
      const element = type === 'image' ? document.createElement('img') : document.createElement('video');
      element.onload = () => resolve(element);
      element.onerror = (e) => {
        attempts++;
        if (attempts <= maxRetries) {
          console.warn(`Retry ${attempts} for ${url}`, e);
          setTimeout(load, retryDelay * attempts);
        } else {
          reject(new Error(`Failed to load ${type} after ${maxRetries} attempts: ${url}`));
        }
      };
      element.src = url;
    };
    load();
  });
}

/* Apply background with forced DOM refresh and error handling */
function applyBackground() {
  if (lastBlobUrl) {
    URL.revokeObjectURL(lastBlobUrl);
    lastBlobUrl = null;
  }

  bgImage.style.display = 'none';
  bgVideo.style.display = 'none';
  bgVideo.src = '';
  bgImage.src = '';

  bgImage.style.visibility = 'hidden';
  bgVideo.style.visibility = 'hidden';

  let targetUrl = settings.backgroundData;
  const cacheBuster = targetUrl.startsWith('blob:') ? '' : `?t=${new Date().getTime()}`;

  // Utiliser le fond par défaut si l'URL n'est pas valide
  if (!isValidUrl(targetUrl) || (targetUrl.startsWith('http') && !checkConnectivity())) {
    console.warn('Invalid URL or no network, using default background');
    targetUrl = DEFAULTS.backgroundData;
    settings.backgroundType = 'image';
    settings.backgroundData = targetUrl;
    saveSettings();
  }

  const applyResource = (url, type) => {
    loadResource(url + cacheBuster, type)
      .then((element) => {
        if (type === 'video') {
          bgVideo.replaceWith(element);
          bgVideo = element;
          bgVideo.style.display = 'block';
          bgVideo.style.visibility = 'visible';
          bgVideo.play();
          showToast('Vidéo chargée avec succès');
          console.log('Video loaded:', url);
        } else {
          bgImage.replaceWith(element);
          bgImage = element;
          bgImage.style.display = 'block';
          bgImage.style.visibility = 'visible';
          showToast('Fond d\'écran chargé avec succès');
          console.log('Image loaded:', url);
        }
      })
      .catch((error) => {
        console.error('Resource load error:', error);
        
        settings.backgroundType = 'image';
        settings.backgroundData = DEFAULTS.backgroundData;
        saveSettings();
        setTimeout(() => applyResource(DEFAULTS.backgroundData, 'image'), 100);
      });
  };

  if (settings.backgroundType === 'video' && targetUrl) {
    applyResource(targetUrl, 'video');
  } else if (settings.backgroundType === 'image' && targetUrl) {
    applyResource(targetUrl, 'image');
  } else {
    applyResource(DEFAULTS.backgroundData, 'image');
  }

  setTimeout(() => {
    bgImage.style.display = bgImage.style.display;
    bgVideo.style.display = bgVideo.style.display;
  }, 0);
}

const debouncedApplyBackground = debounce(applyBackground, 200);

/* Apply root css variables from settings */
function applySettingsToCSS(){
  document.documentElement.style.setProperty('--taskbar-size', settings.taskbarSize + 'px');
  const size = settings.iconSizes[settings.iconSize] || settings.iconSizes.medium;
  document.documentElement.style.setProperty('--icon-size', size + 'px');
  document.documentElement.style.setProperty('--taskbar-transparency', settings.taskbarTransparency);
  document.documentElement.style.setProperty('--taskbar-position', settings.taskbarPosition);
  document.documentElement.style.setProperty('--dock-zoom', settings.dockZoom);
  document.documentElement.style.setProperty('--dock-radius', settings.dockRadius);
  document.documentElement.setAttribute('data-animations', settings.animations ? '1' : '0');
  if(settings.theme === 'dark'){
    document.body.style.backgroundColor = '#0d1117';
  } else if(settings.theme === 'light'){
    document.body.style.backgroundColor = '#e9eef5';
  } else {
    document.body.style.background = 'linear-gradient(135deg,#0f0f1a,#071428)';
  }
  taskbar.classList.remove('top','bottom','left','right');
  taskbar.classList.add(settings.taskbarPosition);
  if(settings.taskbarPosition==='left' || settings.taskbarPosition==='right'){
    taskbar.style.width = settings.taskbarSize + 'px';
    taskbar.style.height = '100%';
    taskbar.style.left = '0';
    taskbar.style.transform = '';
    desktop.style[settings.taskbarPosition] = settings.taskbarSize + 'px';
    desktop.style.bottom = '0';
  } else {
    taskbar.style.height = settings.taskbarSize + 'px';
    taskbar.style.width = 'auto';
    taskbar.style.left = '50%';
    taskbar.style.transform = 'translateX(-50%)';
    desktop.style.bottom = (settings.taskbarPosition==='bottom' ? settings.taskbarSize + 10 + 'px' : '0');
    desktop.style.top = (settings.taskbarPosition==='top' ? settings.taskbarSize + 10 + 'px' : '0');
    desktop.style.left = '0';
    desktop.style.right = '0';
  }
  debouncedApplyBackground();
}

/* Save settings */
function saveSettings(){
  localStorage.setItem('emulatorSettings', JSON.stringify(settings));
  applySettingsToCSS();
}

/* Reset settings */
function resetSettings(){
  if (lastBlobUrl) {
    URL.revokeObjectURL(lastBlobUrl);
    lastBlobUrl = null;
  }
  settings = Object.assign({}, DEFAULTS);
  saveSettings();
  showToast('Paramètres réinitialisés à la valeur par défaut');
}

/* ==========================
   Apps & icons (scan.php fallback)
   ========================== */
let iconPositions = JSON.parse(localStorage.getItem('iconPositions') || '{}');
let appsMap = {};

function loadApps(){
  fetch('scan.php').then(r=>r.json()).then(apps=>{
    if(!Array.isArray(apps) || apps.length===0) throw new Error('no apps');
    apps.forEach((app,i)=> createIcon(app,i));
    populateStartMenu(apps);
  }).catch(err=>{
    const apps = [
      {name:'Explorer', icon:'https://img.icons8.com/fluency/48/000000/folder-invoices.png', path:'about:blank'},
      {name:'Terminal', icon:'https://img.icons8.com/fluency/48/000000/console.png', path:'about:blank'},
      {name:'Notes', icon:'https://img.icons8.com/fluency/48/000000/note.png', path:'about:blank'},
      {name:'Web', icon:'https://img.icons8.com/fluency/48/000000/internet.png', path:'https://example.com'},
    ];
    apps.forEach((app,i)=> createIcon(app,i));
    populateStartMenu(apps);
  });
}

/* collision check */
function checkCollision(newLeft,newTop,size){
  for(const key in iconPositions){
    const pos = iconPositions[key];
    if(Math.abs(pos.left - newLeft) < size && Math.abs(pos.top - newTop) < size) return true;
  }
  return false;
}

/* create icon */
function createIcon(app,index){
  const icon = document.createElement('div'); icon.className='icon';
  icon.dataset.app=app.name; icon.dataset.path = app.path || '';
  const sizePixels = settings.iconSizes[settings.iconSize];
  let left = 20 + index * (sizePixels + 10), top = 20;
  if(iconPositions[app.name]){ left = iconPositions[app.name].left; top = iconPositions[app.name].top; }
  else {
    while(checkCollision(left,top,sizePixels)){
      left += sizePixels + 10; if(left > window.innerWidth - sizePixels){ left = 20; top += sizePixels + 10; }
    }
    iconPositions[app.name] = {left,top};
    localStorage.setItem('iconPositions', JSON.stringify(iconPositions));
  }
  icon.style.left = left+'px'; icon.style.top = top+'px';
  icon.innerHTML = `<img src="${app.icon}" alt="${app.name}"><span>${app.name}</span>`;
  desktop.appendChild(icon);

  let offsetX=0,offsetY=0,isDragging=false;
  icon.addEventListener('mousedown', e=>{
    if(e.button!==0) return;
    isDragging=true; offsetX = e.clientX - icon.offsetLeft; offsetY = e.clientY - icon.offsetTop;
    icon.style.zIndex = 1200;
  });
  document.addEventListener('mousemove', e=>{
    if(!isDragging) return;
    let x = e.clientX - offsetX, y = e.clientY - offsetY;
    x = Math.max(0, Math.min(x, window.innerWidth - sizePixels));
    y = Math.max(0, Math.min(y, window.innerHeight - sizePixels - settings.taskbarSize));
    icon.style.left = x+'px'; icon.style.top = y+'px';
  });
  document.addEventListener('mouseup', e=>{
    if(isDragging){
      isDragging=false; icon.style.zIndex = '';
      iconPositions[app.name] = {left:parseInt(icon.style.left), top:parseInt(icon.style.top)};
      localStorage.setItem('iconPositions', JSON.stringify(iconPositions));
    }
  });

  icon.addEventListener('dblclick', ()=> openApp(app));
  icon.addEventListener('contextmenu', e=>{
    e.preventDefault(); showContextMenuForIcon(e,icon);
  });

  const tbIcon = document.createElement('div'); tbIcon.className='taskbar-icon';
  tbIcon.dataset.app = app.name; tbIcon.innerHTML = `<img src="${app.icon}" alt="${app.name}">`;
  tbIcon.addEventListener('click', ()=> openApp(app));
  const dockWrapper = document.createElement('div'); dockWrapper.className='dock-item';
  dockWrapper.appendChild(tbIcon);
  taskbarCenter.appendChild(dockWrapper);

  appsMap[app.name] = {icon, tbIcon, dockWrapper, win: null};
  return appsMap[app.name];
}

/* populate start menu */
function populateStartMenu(apps){
  const sm = document.getElementById('start-apps'); sm.innerHTML='';
  apps.forEach(a=>{
    const d = document.createElement('div'); d.className='tab app'; d.textContent=a.name;
    d.addEventListener('click', ()=> openApp(a));
    sm.appendChild(d);
  });
}

/* context menu icon */
let currentIcon = null;
function showContextMenuForIcon(e,icon){
  currentIcon = icon;
  const cm = document.getElementById('context-menu');
  cm.style.left = e.clientX+'px'; cm.style.top = e.clientY+'px';
  cm.style.display = 'block'; cm.innerHTML = '';
  const actions = [
    {k:'open', t:'Ouvrir'},
    {k:'remove', t:'Supprimer du bureau'},
    {k:'delete', t:'Supprimer définitivement'},
    {k:'settings', t:'Paramètres'}
  ];
  actions.forEach(a=>{
    const it = document.createElement('div'); it.className='context-item'; it.textContent=a.t;
    it.addEventListener('click', ()=> { cm.style.display='none'; handleIconAction(a.k); });
    cm.appendChild(it);
  });
}

/* handle icon action */
function handleIconAction(key){
  if(!currentIcon) return;
  if(key==='open'){ currentIcon = null; return; }
  if(key==='settings'){ openSettingsWindow(); currentIcon = null; return; }
  if(key==='remove'){ currentIcon.remove(); if(iconPositions[currentIcon.dataset.app]) delete iconPositions[currentIcon.dataset.app]; localStorage.setItem('iconPositions', JSON.stringify(iconPositions)); currentIcon=null; return; }
  if(key==='delete'){
    fetch(`move_to_trash.php?app=${encodeURIComponent(currentIcon.dataset.app)}`).then(r=>r.json()).then(d=>{
      if(d.success) showToast(d.message); else showToast(d.error,'error');
      currentIcon.remove(); currentIcon=null;
    }).catch(err=>{ showToast('Erreur suppression', 'error'); currentIcon.remove(); currentIcon=null; });
  }
}

/* hide context on click elsewhere */
document.addEventListener('click', e=>{
  const cm = document.getElementById('context-menu');
  if(!cm.contains(e.target)) cm.style.display='none';
});

/* ==========================
   Windows / Apps
   ========================== */
function updateIndicator(map) {
  const tb = map.tbIcon;
  tb.classList.remove('open', 'minimized');
  if (map.win) {
    if (map.win.style.display === 'none') {
      tb.classList.add('minimized');
    } else {
      tb.classList.add('open');
    }
  }
}

function openApp(app){
  let map = appsMap[app.name];
  if (!map) return;

  if (settings.launchBounce && settings.animations && !map.win) {
    map.tbIcon.classList.add('bouncing');
    setTimeout(() => map.tbIcon.classList.remove('bouncing'), 600);
  }

  let win = map.win;
  const name = app.name.replace(/\s+/g,'-');
  if(!win){
    win = document.createElement('div'); win.id = 'window-' + name; win.className='window-frame show';
    win.style.left='100px'; win.style.top='100px'; win.dataset.maximized='false';
    const header = document.createElement('div'); header.className='window-header';
    header.innerHTML = `<div class="window-controls"><span class="close"></span><span class="min"></span><span class="max"></span></div><div class="window-title">${app.name}</div>`;
    const body = document.createElement('div'); body.className='window-body';
    const iframe = document.createElement('iframe'); iframe.src = app.path.replace(/\\/g,'/'); iframe.style.border='none'; iframe.style.width='100%'; iframe.style.height='100%';
    body.appendChild(iframe);
    win.appendChild(header); win.appendChild(body);
    document.body.appendChild(win);

    header.querySelector('.close').addEventListener('click', ()=> {
      if (settings.closeAnimation && settings.animations) {
        win.style.transition = 'opacity 0.3s ease, transform 0.3s ease';
        win.style.opacity = '0';
        win.style.transform = 'scale(0.95)';
        setTimeout(() => {
          win.remove();
          map.win = null;
          updateIndicator(map);
        }, 300);
      } else {
        win.remove();
        map.win = null;
        updateIndicator(map);
      }
    });
    header.querySelector('.min').addEventListener('click', ()=> {
      if (settings.minimizeAnimation && settings.animations) {
        const iconRect = map.tbIcon.getBoundingClientRect();
        win.style.transition = 'all 0.3s ease';
        win.style.position = 'fixed';
        win.style.left = `${iconRect.left}px`;
        win.style.top = `${iconRect.top}px`;
        win.style.width = `${iconRect.width}px`;
        win.style.height = `${iconRect.height}px`;
        win.style.opacity = '0';
        setTimeout(() => {
          win.style.display = 'none';
          win.style.transition = '';
          win.style.opacity = '1';
          win.style.width = '800px';
          win.style.height = '600px';
          win.style.left = '100px';
          win.style.top = '100px';
          updateIndicator(map);
        }, 300);
      } else {
        win.style.display = 'none';
        updateIndicator(map);
      }
    });
    header.querySelector('.max').addEventListener('click', ()=> {
      if(win.dataset.maximized==='true'){
        win.style.width='800px'; win.style.height='600px'; win.style.left='100px'; win.style.top='100px'; win.dataset.maximized='false';
      } else {
        const desktopRect = desktop.getBoundingClientRect();
        win.style.left = desktopRect.left + 'px'; win.style.top = desktopRect.top + 'px';
        win.style.width = desktopRect.width + 'px'; win.style.height = desktopRect.height + 'px';
        win.dataset.maximized='true';
      }
    });

    header.onmousedown = function(e){
      if(win.dataset.maximized==='true') return;
      let offsetX = e.clientX - win.offsetLeft, offsetY = e.clientY - win.offsetTop;
      document.onmousemove = function(e){ win.style.left = (e.clientX - offsetX) + 'px'; win.style.top = (e.clientY - offsetY) + 'px'; }
      document.onmouseup = function(){ document.onmousemove=null; document.onmouseup=null; }
    };

    map.win = win;
  } else {
    win.style.display='flex';
  }
  updateIndicator(map);
}

/* ==========================
   Settings modal (tabs)
   ========================== */
const settingsBtn = document.getElementById('settings-btn');
settingsBtn.addEventListener('click', () => openSettingsWindow());

function openSettingsWindow(){
  if(document.getElementById('window-settings')) { document.getElementById('window-settings').style.display='flex'; return; }
  const win = document.createElement('div'); win.id='window-settings'; win.className='window-frame show';
  win.style.left='150px'; win.style.top='120px'; win.style.width='760px'; win.style.height='520px';
  const header = document.createElement('div'); header.className='window-header'; 
  header.innerHTML = `<div class="window-controls"><span class="close"></span></div><div class="window-title">Paramètres</div>`;
  const body = document.createElement('div'); body.className='window-body'; body.style.padding='0';

  const settingsModal = document.createElement('div'); settingsModal.className='settings-modal';
  const sHeader = document.createElement('div'); sHeader.className='settings-header'; 
  sHeader.innerHTML = `<div style="font-weight:700">Paramètres système</div><div><button id="save-settings" class="btn">Enregistrer</button> <button id="reset-settings" class="btn" style="background:#e74c3c">Réinitialiser</button></div>`;
  const sBody = document.createElement('div'); sBody.className='settings-body';
  const sTabs = document.createElement('div'); sTabs.className='settings-tabs';
  const sContent = document.createElement('div'); sContent.className='tab-content';

  const tabs = [
    {id:'appearance', label:'Apparence'},
    {id:'taskbar', label:'Barre des tâches'},
    {id:'icons', label:'Icônes'},
    {id:'system', label:'Système'}
  ];
  tabs.forEach(t => {
    const el = document.createElement('div'); el.className='tab'; el.dataset.tab = t.id; el.textContent = t.label;
    if(t.id==='appearance') el.classList.add('active');
    el.addEventListener('click', () => {
      sTabs.querySelectorAll('.tab').forEach(x => x.classList.remove('active')); el.classList.add('active'); renderTabContent(t.id);
    });
    sTabs.appendChild(el);
  });

  function makeSectionTitle(text) {
    const title = document.createElement('h4'); title.style.marginBottom = '12px'; title.style.fontSize = '16px'; title.textContent = text;
    return title;
  }

  function renderTabContent(id) {
    sContent.innerHTML = '';
    if(id==='appearance'){
      sContent.appendChild(makeSectionTitle('Thème & animations'));
      const themeRow = document.createElement('div'); themeRow.className='control'; 
      themeRow.innerHTML = `<label>Thème</label><select id="theme-select" class="select"><option value="dark">Sombre</option><option value="light">Clair</option><option value="rgb">RGB</option></select>`;
      sContent.appendChild(themeRow);

      const animRow = document.createElement('div'); animRow.className='control'; 
      animRow.innerHTML = `<label>Animations</label><label class="switch"><input id="anim-toggle" type="checkbox"> Activer</label>`;
      sContent.appendChild(animRow);

      const transRow = document.createElement('div'); transRow.className='control'; 
      transRow.innerHTML = `<label>Transparence barre</label><input id="trans-range" type="range" min="0" max="1" step="0.05" value="${settings.taskbarTransparency}"> <span id="trans-val">${settings.taskbarTransparency}</span>`;
      sContent.appendChild(transRow);

      const minAnimRow = document.createElement('div'); minAnimRow.className='control'; 
      minAnimRow.innerHTML = `<label>Animation minimiser</label><label class="switch"><input id="min-anim-toggle" type="checkbox"> Activer</label>`;
      sContent.appendChild(minAnimRow);

      const closeAnimRow = document.createElement('div'); closeAnimRow.className='control'; 
      closeAnimRow.innerHTML = `<label>Animation fermer</label><label class="switch"><input id="close-anim-toggle" type="checkbox"> Activer</label>`;
      sContent.appendChild(closeAnimRow);

      const launchBounceRow = document.createElement('div'); launchBounceRow.className='control'; 
      launchBounceRow.innerHTML = `<label>Rebond lancement</label><label class="switch"><input id="launch-bounce-toggle" type="checkbox"> Activer</label>`;
      sContent.appendChild(launchBounceRow);

      const themeSel = sContent.querySelector('#theme-select'); themeSel.value = settings.theme;
      themeSel.addEventListener('change', e => { settings.theme = e.target.value; saveSettings(); });

      const animToggle = sContent.querySelector('#anim-toggle'); animToggle.checked = settings.animations;
      animToggle.addEventListener('change', e => { settings.animations = e.target.checked; saveSettings(); });

      const minAnimToggle = sContent.querySelector('#min-anim-toggle'); minAnimToggle.checked = settings.minimizeAnimation;
      minAnimToggle.addEventListener('change', e => { settings.minimizeAnimation = e.target.checked; saveSettings(); });

      const closeAnimToggle = sContent.querySelector('#close-anim-toggle'); closeAnimToggle.checked = settings.closeAnimation;
      closeAnimToggle.addEventListener('change', e => { settings.closeAnimation = e.target.checked; saveSettings(); });

      const launchBounceToggle = sContent.querySelector('#launch-bounce-toggle'); launchBounceToggle.checked = settings.launchBounce;
      launchBounceToggle.addEventListener('change', e => { settings.launchBounce = e.target.checked; saveSettings(); });

      const transRange = sContent.querySelector('#trans-range'); const transVal = sContent.querySelector('#trans-val');
      transRange.addEventListener('input', e => { transVal.textContent = e.target.value; settings.taskbarTransparency = parseFloat(e.target.value); saveSettings(); });
    } else if(id==='taskbar'){
      sContent.appendChild(makeSectionTitle('Position & taille'));
      const posRow = document.createElement('div'); posRow.className='control'; 
      posRow.innerHTML = `<label>Position</label><select id="taskbar-pos" class="select"><option value="bottom">Bas</option><option value="top">Haut</option><option value="left">Gauche</option><option value="right">Droite</option></select>`;
      sContent.appendChild(posRow);
      const sizeRow = document.createElement('div'); sizeRow.className='control'; 
      sizeRow.innerHTML = `<label>Taille barre</label><select id="taskbar-size" class="select"><option value="40">Petite</option><option value="60">Moyenne</option><option value="80">Grande</option></select>`;
      sContent.appendChild(sizeRow);

      sContent.appendChild(makeSectionTitle('Dock'));
      const dockRow = document.createElement('div'); dockRow.className='control'; 
      dockRow.innerHTML = `<label>Effet Dock</label><label class="switch"><input id="dock-toggle" type="checkbox"> Activer</label>`;
      sContent.appendChild(dockRow);
      const zoomRow = document.createElement('div'); zoomRow.className='control'; 
      zoomRow.innerHTML = `<label>Zoom max</label><input id="dock-zoom" type="range" min="1.2" max="3" step="0.05" value="${settings.dockZoom}"><span id="dock-zoom-val">${settings.dockZoom}</span>`;
      sContent.appendChild(zoomRow);
      const radiusRow = document.createElement('div'); radiusRow.className='control'; 
      radiusRow.innerHTML = `<label>Rayon effet (px)</label><input id="dock-radius" type="range" min="40" max="300" step="5" value="${settings.dockRadius}"><span id="dock-radius-val">${settings.dockRadius}</span>`;
      sContent.appendChild(radiusRow);

      const posSel = sContent.querySelector('#taskbar-pos'); posSel.value = settings.taskbarPosition;
      posSel.addEventListener('change', e => { settings.taskbarPosition = e.target.value; saveSettings(); });

      const sizeSel = sContent.querySelector('#taskbar-size'); sizeSel.value = settings.taskbarSize;
      sizeSel.addEventListener('change', e => { settings.taskbarSize = parseInt(e.target.value); saveSettings(); });

      const dockToggle = sContent.querySelector('#dock-toggle'); dockToggle.checked = settings.dockEffect;
      dockToggle.addEventListener('change', e => { settings.dockEffect = e.target.checked; saveSettings(); });

      const zoomRange = sContent.querySelector('#dock-zoom'); const zoomVal = sContent.querySelector('#dock-zoom-val');
      zoomRange.addEventListener('input', e => { zoomVal.textContent = e.target.value; settings.dockZoom = parseFloat(e.target.value); saveSettings(); });

      const radiusRange = sContent.querySelector('#dock-radius'); const radiusVal = sContent.querySelector('#dock-radius-val');
      radiusRange.addEventListener('input', e => { radiusVal.textContent = e.target.value; settings.dockRadius = parseInt(e.target.value); saveSettings(); });
    } else if(id==='icons'){
      sContent.appendChild(makeSectionTitle('Taille des icônes'));
      const sizeRow = document.createElement('div'); sizeRow.className='control'; 
      sizeRow.innerHTML = `<label>Taille</label><select id="icon-size" class="select"><option value="small">Petite</option><option value="medium">Moyenne</option><option value="large">Grande</option></select>`;
      sContent.appendChild(sizeRow);

      const sizeSel = sContent.querySelector('#icon-size'); sizeSel.value = settings.iconSize;
      sizeSel.addEventListener('change', e => { settings.iconSize = e.target.value; saveSettings(); });
    } else if(id==='system'){
      sContent.appendChild(makeSectionTitle('Réinitialisation'));
      const resetRow = document.createElement('div'); resetRow.className='control'; 
      resetRow.innerHTML = `<label></label><button id="reset-btn" class="btn" style="background:#e74c3c">Réinitialiser tout</button>`;
      sContent.appendChild(resetRow);

      const resetBtn = sContent.querySelector('#reset-btn');
      resetBtn.addEventListener('click', () => { if(confirm('Êtes-vous sûr de réinitialiser tous les paramètres ?')) resetSettings(); });
    }
  }

  win.appendChild(header); win.appendChild(body);
  body.appendChild(settingsModal);
  settingsModal.appendChild(sHeader); settingsModal.appendChild(sBody);
  sBody.appendChild(sTabs); sBody.appendChild(sContent);
  document.body.appendChild(win);

  header.querySelector('.close').addEventListener('click', () => win.remove());
  renderTabContent('appearance');

  const saveBtn = settingsModal.querySelector('#save-settings');
  saveBtn.addEventListener('click', () => { saveSettings(); showToast('Paramètres enregistrés'); });

  const resetBtn = settingsModal.querySelector('#reset-settings');
  resetBtn.addEventListener('click', () => { if(confirm('Réinitialiser tous les paramètres ?')) resetSettings(); });
}

/* ==========================
   Fullscreen toggle
   ========================== */
const fullscreenBtn = document.getElementById('fullscreen-btn');
fullscreenBtn.addEventListener('click', () => {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen();
    desktop.classList.add('fullscreen');
  } else {
    document.exitFullscreen();
    desktop.classList.remove('fullscreen');
  }
});

/* ==========================
   Toast notifications
   ========================== */
function showToast(message, type='success') {
  const toast = document.createElement('div'); toast.className='toast'; toast.className += type === 'error' ? ' error' : '';
  toast.textContent = message;
  document.body.appendChild(toast);
  setTimeout(() => toast.remove(), 3000);
}

/* Initialize */
document.addEventListener('DOMContentLoaded', () => {
  applySettingsToCSS();
  loadApps();
});
</script>
</body>
</html>